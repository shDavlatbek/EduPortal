{% extends 'layouts/main.html' %}
{% load i18n %}
{% load static %}
{% load custom_tags %}

{% block content %}
<!-- Breadcrumbs and Title -->
<div class="card bg-light-info shadow-none position-relative overflow-hidden mb-4">
  <div class="card-body p-0 m-0">
    <div class="row align-items-center">
      <div class="col-9">
        <h4 class="fw-semibold mb-8">{% trans "students_management" %}</h4>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">{% trans "dashboard" %}</a></li>
            <li class="breadcrumb-item {% if not student_detail %}active{% endif %}" aria-current="page">{% if not student_detail %}{% trans "students" %}{% else %}<a href="{% url 'user' %}">{% trans "students" %}</a>{% endif %}</li>
            <li class="breadcrumb-item {% if student_detail %}active{% endif %}" aria-current="page">{% trans "student_details" %}</li>
          </ol>
        </nav>
      </div>
      <div class="col-3 text-end">
        {% if not student_detail %}
          <button type="button" class="btn btn-primary d-flex align-items-center ms-auto" data-bs-toggle="modal" data-bs-target="#addStudentModal">
            <i class="ti ti-user-plus me-1"></i> {% trans "add_student" %}
          </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if messages %}
<div class="row mb-4">
  <div class="col-12">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags|message_tags }}" role="alert">
      <div class="d-flex align-items-center">
        <i class="ti ti-info-circle fs-5 me-2 flex-shrink-0 text-{{ message.tags|message_tags }}"></i>
        {{ message }}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% if not student_detail %}
<div class="card">
  <div class="card-body">
    <div class="d-flex flex-column flex-md-row align-items-center justify-content-between mb-4">
      <h5 class="card-title fw-semibold mb-0">{% trans "Students List" %}</h5>
      <div class="d-flex gap-2 mt-lg-0 mt-3">
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
          <i class="ti ti-filter me-1"></i> {% trans "filters" %}
          {% if is_filtered %}
          <span class="badge bg-primary rounded-pill ms-1 px-2" style="font-size: 0.6em;">{{ filter_count }}</span>
          {% endif %}
        </button>
        <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#exportModal">
          <i class="ti ti-file-export me-1"></i> {% trans "export" %}
        </button>
        <form method="get" action="" class="d-flex">
          <div class="input-group">
            <input class="form-control" type="search" name="search" placeholder="{% trans 'Search by name or major...' %}" value="{{ search_query }}" aria-label="Search">
            <button class="btn btn-primary" type="submit">
              <i class="ti ti-search"></i>
            </button>
            {% if search_query or is_filtered %}
              <a href="{% url 'user' %}" class="btn btn-outline-secondary px-2 px-lg-3">
                <i class="ti ti-x"></i>
              </a>
            {% endif %}
          </div>
        </form>
      </div>
    </div>

    <!-- Filters Collapse -->
    <div class="collapse mb-4 {% if is_filtered %}show{% endif %}" id="filterCollapse">
      <div class="card card-body bg-light-secondary border">
        <form method="get" action="" id="filterForm">
          {% if search_query %}
          <input type="hidden" name="search" value="{{ search_query }}">
          {% endif %}
          
          <div class="row g-3">
            <!-- Education Type Filter -->
            <div class="col-lg-4">
              <label for="filter_education_type" class="form-label">{% trans "education_type" %}</label>
              <select class="form-select" id="filter_education_type" name="education_type" onchange="document.getElementById('filterForm').submit()">
                <option value="">{% trans "all" %}</option>
                {% for choice in education_choices %}
                  <option value="{{ choice.0 }}" {% if filter_education_type == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                {% endfor %}
              </select>
            </div>
            
            <!-- Education Level Filter -->
            <div class="col-lg-4">
              <label for="filter_education_level" class="form-label">{% trans "education_level_course" %}</label>
              <select class="form-select" id="filter_education_level" name="education_level" onchange="document.getElementById('filterForm').submit()">
                <option value="">{% trans "all" %}</option>
                <option value="1" {% if filter_education_level == '1' %}selected{% endif %}>1</option>
                <option value="2" {% if filter_education_level == '2' %}selected{% endif %}>2</option>
                <option value="3" {% if filter_education_level == '3' %}selected{% endif %}>3</option>
              </select>
            </div>
            
            <!-- Education Major Filter -->
            <div class="col-lg-4">
              <label for="filter_education_major" class="form-label">{% trans "education_major" %}</label>
              <select class="form-select" id="filter_education_major" name="education_major" onchange="document.getElementById('filterForm').submit()">
                <option value="">{% trans "all" %}</option>
                {% for major in education_majors %}
                  <option value="{{ major.id }}" {% if filter_education_major == major.id|stringformat:"i" %}selected{% endif %}>{{ major }}</option>
                {% endfor %}
              </select>
            </div>
            
            <!-- Gender Filter -->
            <div class="col-lg-4">
              <label for="filter_gender" class="form-label">{% trans "gender" %}</label>
              <select class="form-select" id="filter_gender" name="gender" onchange="document.getElementById('filterForm').submit()">
                <option value="">{% trans "all" %}</option>
                <option value="male" {% if filter_gender == 'male' %}selected{% endif %}>{% trans "male" %}</option>
                <option value="female" {% if filter_gender == 'female' %}selected{% endif %}>{% trans "female" %}</option>
              </select>
            </div>
            
            <!-- Reports Count Filter -->
            <div class="col-lg-4">
              <label for="filter_reports_count" class="form-label">{% trans "reports_count" %}</label>
              <select class="form-select" id="filter_reports_count" name="reports_count" onchange="document.getElementById('filterForm').submit()">
                <option value="">{% trans "all" %}</option>
                <option value="0" {% if filter_reports_count == '0' %}selected{% endif %}>{% trans "no_reports" %}</option>
                <option value="1-5" {% if filter_reports_count == '1-5' %}selected{% endif %}>1-5</option>
                <option value="6-10" {% if filter_reports_count == '6-10' %}selected{% endif %}>6-10</option>
                <option value="10+" {% if filter_reports_count == '10+' %}selected{% endif %}>10+</option>
              </select>
            </div>
            
            <!-- Buttons -->
            <div class="col-12 d-flex justify-content-end mt-3">
              <a href="{% url 'user' %}" class="btn btn-outline-secondary me-2">
                <i class="ti ti-refresh me-1"></i> {% trans "reset_filters" %}
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="ti ti-filter me-1"></i> {% trans "apply_filters" %}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    {% if students %}
      <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 row-cols-xxl-4 g-4">
        {% for student in students %}
        <div class="col">
          <div class="card h-100 shadow-sm hover-shadow">
            <div class="card-header bg-transparent d-flex align-items-center p-3 border-bottom">
              <div class="flex-shrink-0">
                <a href="{% url 'user' %}?student_id={{ student.username }}" class="text-decoration-none">
                  <img src="{{ student.profile.picture.url|default:'/media/Profile/_Default/default.jpg' }}" alt="Profile Picture" class="rounded-circle" style="width: 60px; height: 60px; object-fit: cover;">
                </a>
              </div>
              <div class="ms-3 flex-grow-1 overflow-hidden">
                <a href="{% url 'user' %}?student_id={{ student.username }}" class="text-decoration-none">
                  <h5 class="card-title mb-0 text-truncate fw-semibold">{{ student.profile.full_name|default:student.username }}</h5>
                  <small class="text-muted text-truncate d-block">@{{ student.username }}</small>
                  {% if student.edu_profile.next_education_level %}
                    <small class="text-muted text-truncate d-block">{{ student.edu_profile.next_education_level }} - {% trans "level" %}</small>
                  {% endif %}
                </a>
              </div>
            </div>
            <div class="card-body py-3 d-flex flex-column justify-content-between">
              <div class="mb-2">
                <h6 class="card-subtitle mb-2 d-flex align-items-center">
                  <i class="ti ti-school text-primary me-2"></i>{% trans "next_education_major" %}
                </h6>
                {% if student.edu_profile.next_education_major %}
                  <p class="mb-0 ps-4 text-truncate">{{ student.edu_profile.next_education_major }}</p>
                {% else %}
                  <p class="text-muted mb-0 ps-4">{% trans "Not specified" %}</p>
                {% endif %}
              </div>
              <div class="">
                <h6 class="card-subtitle mb-2 d-flex align-items-center">
                  <i class="ti ti-file-certificate text-primary me-2"></i>{% trans "next_education" %}
                </h6>
                {% if student.edu_profile.next_education %}
                  <p class="mb-0 ps-4 text-truncate">{% translate student.edu_profile.next_education %}</p>
                {% else %}
                  <p class="text-muted mb-0 ps-4">{% trans "Not specified" %}</p>
                {% endif %}
              </div>
            </div>
            <div class="card-footer bg-transparent py-3 d-flex justify-content-between">
              <a href="{% url 'user' %}?student_id={{ student.username }}" class="btn btn-sm btn-outline-primary">
                <i class="ti ti-eye me-1"></i> {% trans "view" %}
              </a>
              <a href="#" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteStudentModal{{ student.id }}">
                <i class="ti ti-trash me-1"></i> {% trans "delete" %}
              </a>
            </div>
          </div>
        </div>
        
        <div class="modal fade" id="deleteStudentModal{{ student.id }}" tabindex="-1" data-bs-backdrop="static" aria-labelledby="deleteStudentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content modal-filled bg-danger-subtle">
                <form method="post">
                  {% csrf_token %}
                  <input type="hidden" name="form_type" value="student_delete">
                  <input type="hidden" name="student_id" value="{{ student.id }}">
                  
                  <div class="modal-header">
                    <h5 class="modal-title" id="deleteStudentModalLabel{{ student.id }}">{% trans "delete_student" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  
                  <div class="modal-body">
                    <p>{% trans "are_you_sure_you_want_to_delete_this_student" %}</p>
                    <p class="text-danger">{% trans "this_action_cannot_be_undone" %}</p>
                  </div>
                  
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "cancel" %}</button>
                    <button type="submit" class="btn btn-danger">{% trans "delete" %}</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        <!-- Delete Student Modal -->
        <div class="modal fade" id="deleteStudentModal{{ student.id }}" tabindex="-1" aria-labelledby="deleteStudentModalLabel{{ student.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteStudentModalLabel{{ student.id }}">{% trans "delete_student" %}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="text-center mb-3">
                  <i class="ti ti-alert-triangle text-danger" style="font-size: 4rem;"></i>
                </div>
                <p class="text-center fs-5">{% trans "are_you_sure_you_want_to_delete_this_student" %}?</p>
                <p class="text-center fw-bold">{{ student.profile.full_name|default:student.username }}</p>
                <p class="text-center text-muted small">{% trans "this_action_cannot_be_undone" %}</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "cancel" %}</button>
                <form method="post">
                  {% csrf_token %}
                  <input type="hidden" name="form_type" value="student_delete">
                  <input type="hidden" name="student_id" value="{{ student.id }}">
                  <button type="submit" class="btn btn-danger">
                    <i class="ti ti-trash me-1"></i> {% trans "delete_student" %}
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if students.paginator.num_pages > 1 %}
      <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if students.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="First">
                <i class="ti ti-chevrons-left"></i>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ students.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="Previous">
                <i class="ti ti-chevron-left"></i>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1" aria-disabled="true"><i class="ti ti-chevrons-left"></i></a>
            </li>
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1" aria-disabled="true"><i class="ti ti-chevron-left"></i></a>
            </li>
          {% endif %}
          
          {% for page_num in students.paginator.page_range %}
            {% if students.number == page_num %}
              <li class="page-item active"><a class="page-link" href="#">{{ page_num }}</a></li>
            {% elif page_num > students.number|add:'-3' and page_num < students.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ page_num }}</a>
              </li>
            {% endif %}
          {% endfor %}
          
          {% if students.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ students.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="Next">
                <i class="ti ti-chevron-right"></i>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ students.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}" aria-label="Last">
                <i class="ti ti-chevrons-right"></i>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1" aria-disabled="true"><i class="ti ti-chevron-right"></i></a>
            </li>
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1" aria-disabled="true"><i class="ti ti-chevrons-right"></i></a>
            </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    {% else %}
      <div class="alert alert-info d-flex align-items-center">
        <i class="ti ti-alert-circle fs-5 me-2"></i>
        {% if search_query %}
          {% trans "No students found matching your search." %}
        {% else %}
          {% trans "No students available." %}
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
{% endif %}
{% if student_detail %}
<!-- Single Student View -->
<div class="card">
  <div class="card-body">
    <!-- Student profile picture and basic info -->
    <div class="text-center mb-4">
      <div class="position-relative d-inline-block">
        <img src="{{ student_detail.profile.picture.url|default:'/media/Profile/_Default/default.jpg' }}" class="rounded-circle img-fluid mb-3" style="width: 150px; height: 150px; object-fit: cover;">
        {% if edit_mode %}
        <label for="picture" class="position-absolute bottom-0 end-0 btn btn-sm btn-primary rounded-circle" style="margin-right: 20px;">
          <i class="ti ti-camera"></i>
          <input type="file" id="picture" name="picture" class="d-none" form="studentEditForm">
        </label>
        {% endif %}
      </div>
      <h4 class="fw-semibold">{{ student_detail.profile.full_name|default:student_detail.username }}</h4>
      <p class="text-muted">@{{ student_detail.username }}</p>
      
      <!-- Password restore button -->
      <div class="mt-2">
        <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#restorePasswordModal">
          <i class="ti ti-key me-1"></i> {% trans "restore_password" %}
        </button>
      </div>
    </div>

    <!-- Tabs for different sections -->
    <div class="card">
      <div class="card-body">
        <ul class="nav nav-tabs justify-content-center justify-content-xl-start" id="studentTabs" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" id="personal-tab" data-bs-toggle="tab" href="#personal" role="tab" aria-controls="personal" aria-selected="true">{% trans "personal_information" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="education-tab" data-bs-toggle="tab" href="#education" role="tab" aria-controls="education" aria-selected="false">{% trans "education" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="certificates-tab" data-bs-toggle="tab" href="#certificates" role="tab" aria-controls="certificates" aria-selected="false">{% trans "language_certificates" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="articles-tab" data-bs-toggle="tab" href="#articles" role="tab" aria-controls="articles" aria-selected="false">{% trans "articles" %}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="reports-tab" data-bs-toggle="tab" href="#reports" role="tab" aria-controls="reports" aria-selected="false">{% trans "reports" %}</a>
          </li>
        </ul>

        <form id="studentEditForm" action="{% url 'user' %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="student_id" value="{{ student_detail.id }}">
          <input type="hidden" name="action" value="update">

          <div class="tab-content mt-4" id="studentTabsContent">
            <!-- Personal Information Tab -->
            <div class="tab-pane fade show active" id="personal" role="tabpanel" aria-labelledby="personal-tab">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title mb-4">{% trans "personal_details" %}</h5>
                  
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="username" class="form-label">{% trans "username" %}</label>
                      {% if edit_mode %}
                        <input type="text" class="form-control" id="username" name="username" value="{{ student_detail.username }}" disabled>
                        <small class="text-muted">{% trans "username_cannot_be_changed" %}</small>
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.username }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="full_name" class="form-label">{% trans "full_name" %}</label>
                      {% if edit_mode %}
                        <input type="text" class="form-control" id="full_name" name="full_name" value="{{ student_detail.profile.full_name|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.profile.full_name|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="email" class="form-label">{% trans "email" %}</label>
                      {% if edit_mode %}
                        <input type="email" class="form-control" id="email" name="email" value="{{ student_detail.profile.email|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.profile.email|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="phone_number" class="form-label">{% trans "phone_number" %}</label>
                      {% if edit_mode %}
                        <input type="text" class="form-control" id="phone_number" name="phone_number" value="{{ student_detail.profile.phone_number|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.profile.phone_number|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="birth_date" class="form-label">{% trans "birth_date" %}</label>
                      {% if edit_mode %}
                        <input type="date" class="form-control" id="birth_date" name="birth_date" value="{{ student_detail.profile.birth_date|date:'Y-m-d'|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.profile.birth_date|date:'Y-m-d'|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="gender" class="form-label">{% trans "gender" %}</label>
                      {% if edit_mode %}
                        <select class="form-select" id="gender" name="gender">
                          <option value="">{% trans "select_gender" %}</option>
                          <option value="male" {% if student_detail.profile.gender == 'male' %}selected{% endif %}>{% trans "male" %}</option>
                          <option value="female" {% if student_detail.profile.gender == 'female' %}selected{% endif %}>{% trans "female" %}</option>
                        </select>
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.profile.gender|default:'-'|capfirst }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="birth_place" class="form-label">{% trans "birth_place" %}</label>
                      {% if edit_mode %}
                        <input type="text" class="form-control" id="birth_place" name="birth_place" value="{{ student_detail.profile.birth_place|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.profile.birth_place|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="living_place" class="form-label">{% trans "living_place" %}</label>
                      {% if edit_mode %}
                        <input type="text" class="form-control" id="living_place" name="living_place" value="{{ student_detail.profile.living_place|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.profile.living_place|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="passport_number" class="form-label">{% trans "passport_number" %}</label>
                      {% if edit_mode %}
                        <input type="text" class="form-control" id="passport_number" name="passport_number" placeholder="AA1234567" value="{{ student_detail.profile.passport_number|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.profile.passport_number|default:'-' }}</p>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Education Tab -->
            <div class="tab-pane fade" id="education" role="tabpanel" aria-labelledby="education-tab">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title mb-4">{% trans "next_education" %}</h5>
                  
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="next_education" class="form-label">{% trans "education_type" %}</label>
                      {% if edit_mode %}
                        <select class="form-select" id="next_education" name="next_education">
                          <option value="">{% trans "select_education_type" %}</option>
                          {% for choice in education_choices %}
                            <option value="{{ choice.0 }}" {% if student_detail.edu_profile.next_education == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                          {% endfor %}
                        </select>
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.edu_profile.get_next_education_display|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="next_education_level" class="form-label">{% trans "education_level_course" %}</label>
                      {% if edit_mode %}
                        <select class="form-select" id="next_education_level" name="next_education_level">
                          <option value="">{% trans "select_level" %}</option>
                          <option value="1" {% if student_detail.edu_profile.next_education_level == '1' %}selected{% endif %}>1</option>
                          <option value="2" {% if student_detail.edu_profile.next_education_level == '2' %}selected{% endif %}>2</option>
                          <option value="3" {% if student_detail.edu_profile.next_education_level == '3' %}selected{% endif %}>3</option>
                        </select>
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.edu_profile.next_education_level|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="next_education_major" class="form-label">{% trans "education_major" %}</label>
                      {% if edit_mode %}
                        <select class="form-select" id="next_education_major" name="next_education_major">
                          <option value="">{% trans "select_education_major" %}</option>
                          {% for major in education_majors %}
                            <option value="{{ major.id }}" {% if student_detail.edu_profile.next_education_major_id == major.id %}selected{% endif %}>{{ major }}</option>
                          {% endfor %}
                        </select>
                      {% else %}
                        <p class="form-control-plaintext">
                          {% if student_detail.edu_profile.next_education_major %}
                            {{ student_detail.edu_profile.next_education_major }}
                          {% else %}
                            -
                          {% endif %}
                        </p>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="card mt-4">
                <div class="card-body">
                  <h5 class="card-title mb-4">{% trans "teacher_information" %}</h5>
                  
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="teacher_full_name" class="form-label">{% trans "teacher_full_name" %}</label>
                      {% if edit_mode %}
                        <input type="text" class="form-control" id="teacher_full_name" name="teacher_full_name" value="{{ student_detail.edu_profile.teacher_full_name|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.edu_profile.teacher_full_name|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="teacher_degree" class="form-label">{% trans "teacher_degree" %}</label>
                      {% if edit_mode %}
                        <input type="text" class="form-control" id="teacher_degree" name="teacher_degree" value="{{ student_detail.edu_profile.teacher_degree|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.edu_profile.teacher_degree|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="teacher_academic_rank" class="form-label">{% trans "teacher_academic_rank" %}</label>
                      {% if edit_mode %}
                        <input type="text" class="form-control" id="teacher_academic_rank" name="teacher_academic_rank" value="{{ student_detail.edu_profile.teacher_academic_rank|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.edu_profile.teacher_academic_rank|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="teacher_work_place_position" class="form-label">{% trans "teacher_work_place_position" %}</label>
                      {% if edit_mode %}
                        <input type="text" class="form-control" id="teacher_work_place_position" name="teacher_work_place_position" value="{{ student_detail.edu_profile.teacher_work_place_position|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.edu_profile.teacher_work_place_position|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="order_number" class="form-label">{% trans "order_number" %}</label>
                      {% if edit_mode %}
                        <input type="text" class="form-control" id="order_number" name="order_number" value="{{ student_detail.edu_profile.order_number|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.edu_profile.order_number|default:'-' }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="order_date" class="form-label">{% trans "order_date" %}</label>
                      {% if edit_mode %}
                        <input type="date" class="form-control" id="order_date" name="order_date" value="{{ student_detail.edu_profile.order_date|date:'Y-m-d'|default:'' }}">
                      {% else %}
                        <p class="form-control-plaintext">{{ student_detail.edu_profile.order_date|date:'Y-m-d'|default:'-' }}</p>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Language Certificates Tab -->
            <div class="tab-pane fade" id="certificates" role="tabpanel" aria-labelledby="certificates-tab">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="card-title">{% trans "language_certificates" %}</h5>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCertificateModal">
                      <i class="ti ti-plus"></i> {% trans "add_certificate" %}
                    </button>
                  </div>
                  
                  {% if student_detail.language_certificates.exists %}
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>{% trans "certificate_name" %}</th>
                          <th>{% trans "date" %}</th>
                          <th>{% trans "file" %}</th>
                          <th>{% trans "actions" %}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for cert in student_detail.language_certificates.all %}
                        <tr>
                          <td>{{ forloop.counter }}</td>
                          <td>{{ cert.certificate_name }}</td>
                          <td>{{ cert.certificate_date|date:"Y-m-d"|default:"-" }}</td>
                          <td>
                            {% if cert.certificate_file %}
                            <a href="{{ cert.certificate_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                              <i class="ti ti-download"></i> {% trans "download" %}
                            </a>
                            {% else %}
                            <span class="badge bg-warning">{% trans "no_file" %}</span>
                            {% endif %}
                          </td>
                          <td>
                            <form method="post" class="d-inline">
                              {% csrf_token %}
                              <input type="hidden" name="form_type" value="certificate_delete">
                              <input type="hidden" name="certificate_id" value="{{ cert.id }}">
                              <input type="hidden" name="student_id" value="{{ student_detail.id }}">
                              <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('{% trans 'are_you_sure_you_want_to_delete_this_certificate?' %}')">
                                <i class="ti ti-trash"></i>
                              </button>
                            </form>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% else %}
                  <div class="alert alert-info">
                    {% trans "not_any_language_certificates" %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <!-- Articles Tab -->
            <div class="tab-pane fade" id="articles" role="tabpanel" aria-labelledby="articles-tab">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="card-title">{% trans "articles" %}</h5>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addArticleModal">
                      <i class="ti ti-plus"></i> {% trans "add_article" %}
                    </button>
                  </div>
                  
                  {% if student_detail.articles.exists %}
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>{% trans "type" %}</th>
                          <th>{% trans "number" %}</th>
                          <th>{% trans "date" %}</th>
                          <th>{% trans "file" %}</th>
                          <th>{% trans "actions" %}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for article in student_detail.articles.all %}
                        <tr>
                          <td>{{ forloop.counter }}</td>
                          <td>{% trans article.article_type %}</td>
                          <td>{{ article.article_number|default:"-" }}</td>
                          <td>{{ article.article_date|date:"Y-m-d"|default:"-" }}</td>
                          <td>
                            {% if article.article_file %}
                            <a href="{{ article.article_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                              <i class="ti ti-download"></i> {% trans "download" %}
                            </a>
                            {% else %}
                            <span class="badge bg-warning">{% trans "no_file" %}</span>
                            {% endif %}
                          </td>
                          <td>
                            <form method="post" class="d-inline">
                              {% csrf_token %}
                              <input type="hidden" name="form_type" value="article_delete">
                              <input type="hidden" name="article_id" value="{{ article.id }}">
                              <input type="hidden" name="student_id" value="{{ student_detail.id }}">
                              <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('{% trans 'are_you_sure_you_want_to_delete_this_article?' %}')">
                                <i class="ti ti-trash"></i>
                              </button>
                            </form>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% else %}
                  <div class="alert alert-info">
                    {% trans "not_any_articles" %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <!-- Reports Tab -->
            <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title mb-4">{% trans "student_reports" %}</h5>
                  
                  {% if student_detail.student_reports.exists %}
                    <div class="table-responsive">
                      <table class="table table-bordered">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>{% trans "title" %}</th>
                            <th>{% trans "type" %}</th>
                            <th>{% trans "status" %}</th>
                            <th>{% trans "due_date" %}</th>
                            <th>{% trans "submitted_at" %}</th>
                            <th>{% trans "actions" %}</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for report in student_detail.student_reports.all %}
                          {% if report.status != 'draft' %}
                          <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ report.title }}</td>
                            <td>{% trans report.report_type %}</td>
                            <td><span class="badge {% if report.status == 'draft' %}bg-warning{% elif report.status == 'submitted' %}bg-info{% elif report.status == 'approved' %}bg-success{% else %}bg-danger{% endif %}">{% trans report.status %}</span></td>
                            <td>{{ report.due_date|date:"Y-m-d H:i"|default:"-" }}</td>
                            <td>{{ report.submitted_at|date:"Y-m-d H:i"|default:"-" }}</td>
                            <td>
                              <a href="{% url "report" %}?search={{ report.title }}&search_field=title" class="btn btn-sm btn-outline-primary">
                                <i class="ti ti-eye"></i>
                              </a>
                              {% if report.file %}
                                <a href="{{ report.file.url }}" target="_blank" class="btn btn-sm btn-outline-info">
                                  <i class="ti ti-download"></i>
                                </a>
                              {% endif %}
                            </td>
                          </tr>
                          {% endif %}
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <div class="alert alert-info">
                      {% trans "no_reports_available_for_this_student" %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Action buttons -->
          <div class="text-end mt-4">
            {% if edit_mode %}
              <button type="submit" class="btn btn-primary">
                <i class="ti ti-device-floppy me-1"></i> {% trans "save_changes" %}
              </button>
              <a href="{% url 'user' %}?student_id={{ student_detail.username }}" class="btn btn-outline-secondary ms-2">
                <i class="ti ti-x me-1"></i> {% trans "cancel" %}
              </a>
            {% else %}
              <a href="{% url 'user' %}?student_id={{ student_detail.username }}&edit=true" class="btn btn-primary">
                <i class="ti ti-edit me-1"></i> {% trans "edit" %}
              </a>
              <a href="{% url 'user' %}" class="btn btn-outline-secondary ms-2">
                <i class="ti ti-arrow-back me-1"></i> {% trans "back_to_list" %}
              </a>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addStudentModalLabel">{% trans "Add New Student" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{% url 'user_add' %}" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="form-floating mb-3">
                <input type="text" class="form-control" id="username" name="username" placeholder="{% trans 'Username' %}" required>
                <label for="username">{% trans "Username" %}</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating mb-3">
                <input type="email" class="form-control" id="email" name="email" placeholder="{% trans 'Email' %}">
                <label for="email">{% trans "Email" %}</label>
              </div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="password" name="password" placeholder="{% trans 'Password' %}" required>
                <label for="password">{% trans "Password" %}</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating mb-3">
                <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="{% trans 'Confirm Password' %}" required>
                <label for="confirm_password">{% trans "Confirm Password" %}</label>
              </div>
            </div>
          </div>
          
          <div class="form-floating mb-3">
            <input type="text" class="form-control" id="full_name" name="full_name" placeholder="{% trans 'Full Name' %}">
            <label for="full_name">{% trans "Full Name" %}</label>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="form-floating mb-3">
                <select class="form-select" id="next_education" name="next_education">
                  <option value="">{% trans "Select" %}</option>
                  {% for choice in education_choices %}
                    <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                  {% endfor %}
                </select>
                <label for="next_education">{% trans "Next Education" %}</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating mb-3">
                <select class="form-select" id="next_education_major" name="next_education_major">
                  <option value="">{% trans "Select" %}</option>
                  {% for major in education_majors %}
                    <option value="{{ major.id }}">{{ major.number }} - {{ major.name }}</option>
                  {% endfor %}
                </select>
                <label for="next_education_major">{% trans "Education Major" %}</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
          <button type="submit" class="btn btn-primary">
            <i class="ti ti-user-plus me-1"></i> {% trans "Add Student" %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Restore Password Modal -->
{% if student_detail %}
<div class="modal fade" id="restorePasswordModal" tabindex="-1" aria-labelledby="restorePasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="restorePasswordModalLabel">{% trans "restore_password" %} - {{ student_detail.username }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{% url 'user' %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="password_reset">
        <input type="hidden" name="student_id" value="{{ student_detail.id }}">
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="ti ti-alert-triangle me-2"></i>
            {% trans "you_are_about_to_reset_the_password_for_this_user" %}
          </div>
          
          <div class="form-floating mb-3">
            <input type="password" class="form-control" id="new_password" name="new_password" placeholder="{% trans 'New Password' %}" required>
            <label for="new_password">{% trans "new_password" %}</label>
          </div>
          
          <div class="form-floating mb-3">
            <input type="password" class="form-control" id="confirm_new_password" name="confirm_new_password" placeholder="{% trans 'Confirm New Password' %}" required>
            <label for="confirm_new_password">{% trans "confirm_new_password" %}</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "cancel" %}</button>
          <button type="submit" class="btn btn-warning">
            <i class="ti ti-key me-1"></i> {% trans "restore_password" %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Certificate Modal -->
<div class="modal fade" id="addCertificateModal" tabindex="-1" aria-labelledby="addCertificateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCertificateModalLabel">{% trans "add_language_certificate" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{% url 'user' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="certificate_add">
        <input type="hidden" name="student_id" value="{{ student_detail.id }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="certificate_name" class="form-label">{% trans "certificate_name" %} <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="certificate_name" name="certificate_name" required>
          </div>
          
          <div class="mb-3">
            <label for="certificate_date" class="form-label">{% trans "certificate_date" %}</label>
            <input type="date" class="form-control" id="certificate_date" name="certificate_date">
          </div>
          
          <div class="mb-3">
            <label for="certificate_file" class="form-label">{% trans "certificate_file" %}</label>
            <input type="file" class="form-control" id="certificate_file" name="certificate_file">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "cancel" %}</button>
          <button type="submit" class="btn btn-primary">
            <i class="ti ti-plus me-1"></i> {% trans "save_certificate" %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Article Modal -->
<div class="modal fade" id="addArticleModal" tabindex="-1" aria-labelledby="addArticleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addArticleModalLabel">{% trans "add_article" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{% url 'user' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="article_add">
        <input type="hidden" name="student_id" value="{{ student_detail.id }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="article_type" class="form-label">{% trans "article_type" %} <span class="text-danger">*</span></label>
            <select class="form-select" id="article_type" name="article_type" required>
              <option value="">{% trans "select_article_type" %}</option>
              <option value="republic_scientific_journal">{% trans "republic_scientific_journal" %}</option>
              <option value="foreign_scientific_journal">{% trans "foreign_scientific_journal" %}</option>
              <option value="republic_conference_journal">{% trans "republic_conference_journal" %}</option>
              <option value="foreign_conference_journal">{% trans "foreign_conference_journal" %}</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="article_number" class="form-label">{% trans "article_number" %}</label>
            <input type="text" class="form-control" id="article_number" name="article_number">
          </div>
          
          <div class="mb-3">
            <label for="article_date" class="form-label">{% trans "article_date" %}</label>
            <input type="date" class="form-control" id="article_date" name="article_date">
          </div>
          
          <div class="mb-3">
            <label for="article_file" class="form-label">{% trans "article_file" %}</label>
            <input type="file" class="form-control" id="article_file" name="article_file">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "cancel" %}</button>
          <button type="submit" class="btn btn-primary">
            <i class="ti ti-plus me-1"></i> {% trans "save_article" %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="exportModalLabel">{% trans "export_students_to_excel" %}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{% url 'export_students' %}" method="get">
        <!-- Pass current filters to export -->
        {% if filter_education_type %}<input type="hidden" name="education_type" value="{{ filter_education_type }}">{% endif %}
        {% if filter_education_level %}<input type="hidden" name="education_level" value="{{ filter_education_level }}">{% endif %}
        {% if filter_education_major %}<input type="hidden" name="education_major" value="{{ filter_education_major }}">{% endif %}
        {% if filter_gender %}<input type="hidden" name="gender" value="{{ filter_gender }}">{% endif %}
        {% if filter_reports_count %}<input type="hidden" name="reports_count" value="{{ filter_reports_count }}">{% endif %}
        {% if search_query %}<input type="hidden" name="search" value="{{ search_query }}">{% endif %}
        
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="ti ti-info-circle me-2"></i>
            {% trans "select_information_to_include_in_export" %}
          </div>
          
          <div class="row mb-4">
            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="mb-3 fw-semibold">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="include_personal" name="include_personal" value="1" checked>
                      <label class="form-check-label fw-semibold" for="include_personal">
                        {% trans "personal_information" %}
                      </label>
                    </div>
                  </h6>
                  
                  <div class="row ps-4">
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_full_name" name="fields" value="full_name" checked>
                        <label class="form-check-label" for="include_full_name">
                          {% trans "full_name" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_gender" name="fields" value="gender" checked>
                        <label class="form-check-label" for="include_gender">
                          {% trans "gender" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_birth_date" name="fields" value="birth_date">
                        <label class="form-check-label" for="include_birth_date">
                          {% trans "birth_date" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_email" name="fields" value="email">
                        <label class="form-check-label" for="include_email">
                          {% trans "email" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_phone" name="fields" value="phone_number">
                        <label class="form-check-label" for="include_phone">
                          {% trans "phone_number" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_birth_place" name="fields" value="birth_place">
                        <label class="form-check-label" for="include_birth_place">
                          {% trans "birth_place" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_living_place" name="fields" value="living_place">
                        <label class="form-check-label" for="include_living_place">
                          {% trans "living_place" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_passport" name="fields" value="passport_number">
                        <label class="form-check-label" for="include_passport">
                          {% trans "passport_number" %}
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="mb-3 fw-semibold">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="include_education" name="include_education" value="1" checked>
                      <label class="form-check-label fw-semibold" for="include_education">
                        {% trans "education" %}
                      </label>
                    </div>
                  </h6>
                  
                  <div class="row ps-4">
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_education_type" name="fields" value="next_education" checked>
                        <label class="form-check-label" for="include_education_type">
                          {% trans "education_type" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_education_level" name="fields" value="next_education_level" checked>
                        <label class="form-check-label" for="include_education_level">
                          {% trans "education_level" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_education_major" name="fields" value="next_education_major" checked>
                        <label class="form-check-label" for="include_education_major">
                          {% trans "education_major" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_bachelor_major" name="fields" value="bachelor_major">
                        <label class="form-check-label" for="include_bachelor_major">
                          {% trans "bachelor_major" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_bachelor_diploma" name="fields" value="bachelor_diploma">
                        <label class="form-check-label" for="include_bachelor_diploma">
                          {% trans "bachelor_diploma" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_master_major" name="fields" value="master_major">
                        <label class="form-check-label" for="include_master_major">
                          {% trans "master_major" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_master_diploma" name="fields" value="master_diploma">
                        <label class="form-check-label" for="include_master_diploma">
                          {% trans "master_diploma" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_teacher_name" name="fields" value="teacher_full_name">
                        <label class="form-check-label" for="include_teacher_name">
                          {% trans "teacher_full_name" %}
                        </label>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="include_teacher_degree" name="fields" value="teacher_degree">
                        <label class="form-check-label" for="include_teacher_degree">
                          {% trans "teacher_degree" %}
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="mb-3 fw-semibold">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="include_certificates" name="include_certificates" value="1">
                      <label class="form-check-label fw-semibold" for="include_certificates">
                        {% trans "language_certificates" %}
                      </label>
                    </div>
                  </h6>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="mb-3 fw-semibold">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="include_articles" name="include_articles" value="1">
                      <label class="form-check-label fw-semibold" for="include_articles">
                        {% trans "articles" %}
                      </label>
                    </div>
                  </h6>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "cancel" %}</button>
          <button type="submit" class="btn btn-success">
            <i class="ti ti-file-export me-1"></i> {% trans "export_to_excel" %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- JavaScript for Export Modal -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle parent checkboxes in export modal
    const personalCheckbox = document.getElementById('include_personal');
    const educationCheckbox = document.getElementById('include_education');
    
    if (personalCheckbox) {
      personalCheckbox.addEventListener('change', function() {
        const personalFields = document.querySelectorAll('input[name="fields"][value^="full_name"], input[name="fields"][value^="gender"], input[name="fields"][value^="birth_date"], input[name="fields"][value^="email"], input[name="fields"][value^="phone_number"], input[name="fields"][value^="birth_place"], input[name="fields"][value^="living_place"], input[name="fields"][value^="passport_number"]');
        personalFields.forEach(field => {
          field.disabled = !this.checked;
          if (!this.checked) {
            field.checked = false;
          }
        });
      });
    }
    
    if (educationCheckbox) {
      educationCheckbox.addEventListener('change', function() {
        const educationFields = document.querySelectorAll('input[name="fields"][value^="next_education"], input[name="fields"][value^="bachelor_"], input[name="fields"][value^="master_"], input[name="fields"][value^="teacher_"]');
        educationFields.forEach(field => {
          field.disabled = !this.checked;
          if (!this.checked) {
            field.checked = false;
          }
        });
      });
    }
    
    // Count active filters
    const countActiveFilters = function() {
      const filterCount = document.getElementById('filterCount');
      if (!filterCount) return;
      
      let count = 0;
      if ('{{ filter_education_type }}') count++;
      if ('{{ filter_education_level }}') count++;
      if ('{{ filter_education_major }}') count++;
      if ('{{ filter_gender }}') count++;
      if ('{{ filter_reports_count }}') count++;
      
      if (count > 0) {
        filterCount.innerText = count;
        filterCount.style.display = 'inline';
      } else {
        filterCount.style.display = 'none';
      }
    };
    
    // Initialize the count
    countActiveFilters();
  });
</script>
{% endblock %}
